app.controller("bookshelfViewCtrl",["$window","$scope","httpService","$ionicModal","fileTransferHelper","curUserService","Config","Popup",function($window,$scope,httpService,$ionicModal,fileTransferHelper,curUserService,config,Popup){function getItemSize(){var height=$window.screen.height,width=$window.screen.width,pageTotal=Math.floor(height*width/$scope.fontSize/8);return pageTotal+=8-pageTotal%8,console.log(pageTotal),pageTotal}function readFile(blob,callback){var a=new FileReader;a.onload=function(e){callback(e.target.result)},a.readAsText(blob,"utf-8")}$scope.fontSize="12",curUserService.test();var isLogined=(curUserService.getCurUser(),!0),sliceIndex=1,bookFile=fileTransferHelper.getter(),itemSize=getItemSize(),total=Math.ceil(bookFile.size/itemSize),lastLeft=bookFile.size%itemSize;$scope.noMoreItemsAvailable=!1,$scope.larger=function(){$scope.fontSize++},$scope.smaller=function(){$scope.fontSize--},$scope.modal=$ionicModal.fromTemplateUrl("operateMenu.html",{scope:$scope}).then(function(modal){$scope.modal=modal}),$scope.sideModal=$ionicModal.fromTemplateUrl("chapterPage.html",{scope:$scope}).then(function(modal){$scope.sideModal=modal});var loadInfo=function(){if(isLogined){var filePath=fileTransferHelper.getter();$scope.filePath=filePath,$scope.loading=!0,httpService.post("app/bookWithChapters",{fileName:filePath}).success(function(d){console.log(d),$scope.textContent=d.fileContent,$scope.chapters=d.chapters,$scope.loading=!1})}else $scope.loadMore()};$scope.loadMore=function(){sliceIndex==total?(readFile(bookFile.slice((sliceIndex-1)*itemSize,(sliceIndex-1)*itemSize+lastLeft),function(result){$scope.textContent+=result}),$scope.noMoreItemsAvailable=!0):sliceIndex<total&&readFile(bookFile.slice((sliceIndex-1)*itemSize,(sliceIndex-1)*itemSize+itemSize),function(result){$scope.textContent=$scope.textContent+result}),sliceIndex++,$scope.$broadcast("scroll.infiniteScrollComplete")},loadInfo()}]);